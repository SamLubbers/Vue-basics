<% extend('../layout') %>

<div class="container" id="app">
<div class="row">
  <div class="col-12">
    <template v-if="users.length > 0">
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th v-for='header in schema' scope="col">{{ header }}</th>
          </tr>
        </thead>
        <tbody>
          <tr class="hoverHighlightInvert"
          v-for='user in users'
          @click='removeUser(user)'>
            <td v-for='(value, key) in user'>{{ value }}</td>
          </tr>
          <tr style="background-color: white">
            <td v-for='(value, key) in newUser'>
              <input type="text"
              :placeholder="key"
              v-model='newUser[key]'
              @keydown.enter='addUser'>
            </td>
          </tr>
        </tbody>
      </table>
      <p style="color:red" v-if='invalidInput'>
        Please fill in all input fields
      </p>
    </template>
    <template v-else>
      <p>Failed creating table</p>
      <p v-if='apiErrorMessage'> API Error: {{ apiErrorMessage }}</p>
    </template>
  </div>
</div>
</div>

<script type="text/javascript">
  new Vue({
    el: '#app',
    data: {
      users: [],
      newUser: {},
      apiErrorMessage: '',
      invalidInput: false
    },
    computed:{
      schema: function(){
        if(this.users.length > 0){
            return Object.keys(this.users[0]);
        }
      }
    },
    watch:{
      schema: function(schema){
        newUser = {};
        schema.map((k, i) => newUser[k] = '');
        this.newUser = Object.assign({}, newUser);
      }
    },
    methods:{
      addUser: function(){
        if (objectHasEmptyValue(this.newUser)) {
          this.invalidInput = true;
        }
        else{
          this.invalidInput = false;
          this.users.push(this.newUser);
        }
      },
      removeUser: function(user){
        this.users.splice(this.users.indexOf(user), 1);
      }
    },
    created(){
      fetch('https://randomuser.me/api/?results=15')
        .then(response => response.json())
        .then(json => {
          for (json_user of json.results) {
            user = {
              'firstName':json_user.name.first,
              'lastName':json_user.name.last,
              'email': json_user.email
            };
            this.users.push(user);
          };
        })
        .catch((err) => this.apiErrorMessage = err.message);
    }
  });
function objectHasEmptyValue(obj) {
  for (var k in obj) {
    if (!obj[k]) {
      return true;
    }
  }
  return false;

}
</script>
